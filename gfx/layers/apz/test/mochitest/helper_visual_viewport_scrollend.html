<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="apz_test_utils.js"></script>
  <script src="apz_test_native_event_utils.js"></script>
  <script src="/tests/SimpleTest/EventUtils.js"></script>
  <script src="/tests/SimpleTest/paint_listener.js"></script>
</head>
<body>
<style>
  #large {
    height: 200vh;
    width: 200vw;
    background: linear-gradient(red, yellow);
  }
</style>
<div id="large"></div>
<script type="application/javascript">
async function test() {
  // Pinch zoom into the center of the Visual Viewport so it's smaller than
  // the layout viewport, and there's space for the Visual Viewport to scroll
  // down without scrolling the window
  await pinchZoomInWithTouch(300, 300);
  await promiseApzFlushedRepaints();

  ok(visualViewport.scale > 1, "page should be zoomed in.");

  const preScrollVisualViewportOffsetTop = visualViewport.offsetTop;
  const preScrollWindowScrollOffset = window.scrollY;

  let visualViewportScrollEndCounter = new EventCounter(visualViewport, "scrollend");

  // Touch drag a small distance so the Visual Viewport position changes, but
  // the Layout Viewport's position does not change
  await promiseNativeTouchDrag(document.documentElement, 300, 300, 0, 10);
  await promiseApzFlushedRepaints();

  is(window.scrollY == preScrollWindowScrollOffset, "the window should not scroll");
  is(visualViewport.offsetTop < preScrollVisualViewportOffsetTop, "visualViewport should be scrolled");

  visualViewportScrollEndCounter.unregister();
  is(visualViewportScrollEndCounter.count, 1, "a visualViewport.scrollend event should have fired");
}

waitUntilApzStable()
.then(test)
.then(subtestDone, subtestFailed);
</script>
</html>
